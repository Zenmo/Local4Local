
services:
    npm-base:
        image: node:22
        working_dir: /webtool/frontend
        volumes:
            - .:/webtool
        command: ["npm", "install"]

    frontend:
        extends:
            service: npm-base
        command: ["npm", "run", "dev"]
        ports:
            - "127.0.0.1:5173:5173"

    postgres:
        image: postgres:16
        environment:
            POSTGRES_USER: webtool
            POSTGRES_PASSWORD: webtool

    gradle-base:
        image: gradle:8.9
        working_dir: /home/gradle/project
        user: gradle
        volumes:
            - ./gradle:/home/gradle/project

    gradle-js:
        extends:
            service: gradle-base
        command: ["gradle", "--project-cache-dir=/tmp/gradle", "--no-daemon", "common:jsBrowserProductionLibraryDistribution"]
        volumes:
            - gradle-js-home:/home/gradle/.gradle

    backend:
        extends:
            service: gradle-base
        command: ["gradle", "--project-cache-dir=/tmp/gradle", "backend:run"]
        ports:
            -   target: 9000
                host_ip: 127.0.0.1
                published: 9000
        volumes:
            - gradle-backend-home:/home/gradle/.gradle

    client-test:
        extends:
            service: gradle-base
        command: ["gradle", "--project-cache-dir=/tmp/gradle", "--no-daemon", "client:test"]
        depends_on:
            -   backend
        environment:
            LOCAL4LOCAL_BACKEND_URL: http://backend:9000
        volumes:
            - gradle-client-test-home:/home/gradle/.gradle

volumes:
    # shared cache of libraries
    gradle-js-home:
    gradle-backend-home:
    gradle-client-test-home:
